var Uploady=function(e){var t=function(e,t){this.id=e,this.file=t,this.fileName=function(){return this.file.name}};"object"!=typeof e&&(e={}),this.onProgress=e.onProgress,this.onSuccess=e.onSuccess,this.onError=e.onError,this.onStarted=e.onStarted,this.onFinished=e.onFinished,this.fileField=e.fileField?e.fileField:"upfile",this.appendData=e.appendData?e.appendData:{},this.requestHeaders=e.requestHeaders?e.requestHeaders:{},this.targetUrl=e.targetUrl,this.singleRequest=e.singleRequest?e.singleRequest:!1;var s=[],i=0;this.addFile=function(e,n){var r=new t(i,e);for(var o in n)r[o]=n[o];s.push(r),i++},this.removeFile=function(e){for(var t=0;t<s.length;t++)if(s[t].id==e)return s.splice(t,1);return null},this.finish=function(e,t,s){this.onFinished&&this.onFinished({total:s,succeed:e,failed:t})},this.setSingleRequest=function(e){this.singleRequest=e};var n=function(){var e=this,t=new XMLHttpRequest,i=new FormData;this.onStarted&&this.onStarted(null,t),t.upload.items=[];for(var n in this.requestHeaders)t.setRequestHeader(n,this.requestHeaders[n]);for(var r=0;r<s.length;r++)t.upload.items.push(s[r]),i.append(this.fileField+r,s[r].file);for(var n in this.appendData)i.append(n,this.appendData[n]);t.upload.addEventListener("progress",function(t){t.lengthComputable?e.onProgress&&e.onProgress(null,t.loaded,t.total):e.onProgress&&e.onProgress(null)}),t.addEventListener("readystatechange",function(){4===this.readyState&&(200!==this.status?(this.abort(),e.onError&&e.onError({status:this.status,file:null})):e.onSuccess&&e.onSuccess({response:this.responseText,file:null}),e.finish())}),t.upload.addEventListener("error",function(t){e.onError&&e.onError({status:t.target.status,file:null}),e.finish()}),t.open("post",e.targetUrl,!0),t.send(i)},r=function(){for(var e=0,t=0,i=0,n=this,r=0;r<s.length;r++){var o=s[r],a=new XMLHttpRequest;this.onStarted&&this.onStarted(o,a),a.upload.item=o;for(var l in this.requestHeaders)a.setRequestHeader(l,this.requestHeaders[l]);var u=new FormData;u.append(this.fileField,o.file);for(var l in this.appendData)u.append(l,this.appendData[l]);a.upload.addEventListener("progress",function(e){e.lengthComputable?n.onProgress&&n.onProgress(this.item,e.loaded,e.total):n.onProgress&&n.onProgress(this.item)}),a.addEventListener("readystatechange",function(){4===this.readyState&&(200!==this.status?(this.abort(),t++,n.onError&&n.onError({status:this.status,file:this.upload.item.file})):(e++,n.onSuccess&&n.onSuccess({file:this.upload.item.file,response:this.responseText})),i++,i==s.length&&n.finish())}),a.upload.addEventListener("error",function(e){t++,i++,n.onError&&n.onError({status:e.target.status,file:this.item.file}),i==s.length&&n.finish()}),a.open("post",n.targetUrl,!0),a.send(u)}};this.upload=function(){this.singleRequest?n():r()},this.clear=function(){s=[]}};